pipeline {
    agent any
    
    environment {
        AWS_DEFAULT_REGION = 'us-east-1'
        TF_VAR_bucket_name = "${env.BRANCH_NAME}-site-estatico-${env.BUILD_NUMBER}"
        TF_VAR_environment = "${env.BRANCH_NAME == 'main' ? 'prod' : 'dev'}"
        TF_VAR_project_name = 'static-website-cicd'
        TF_IN_AUTOMATION = 'true'
        TF_INPUT = 'false'
    }
    
    parameters {
        choice(
            name: 'ACTION',
            choices: ['plan', 'apply', 'destroy'],
            description: 'A√ß√£o do Terraform a ser executada'
        )
        booleanParam(
            name: 'AUTO_APPROVE',
            defaultValue: false,
            description: 'Aplicar automaticamente sem confirma√ß√£o (apenas para dev)'
        )
    }
    
    stages {
        stage('üèÅ Checkout') {
            steps {
                echo 'üì• Fazendo checkout do c√≥digo...'
                checkout scm
                script {
                    // Mostrar informa√ß√µes do build
                    echo "üîç Build Info:"
                    echo "Branch: ${env.BRANCH_NAME}"
                    echo "Build Number: ${env.BUILD_NUMBER}"
                    echo "Action: ${params.ACTION}"
                    echo "Bucket Name: ${env.TF_VAR_bucket_name}"
                }
            }
        }
        
        stage('üîß Setup Terraform') {
            steps {
                script {
                    echo '‚öôÔ∏è Configurando Terraform...'
                    dir('terraform') {
                        // Verificar vers√£o do Terraform
                        sh 'terraform version'
                        
                        // Inicializar Terraform
                        sh 'terraform init -no-color'
                        
                        echo '‚úÖ Terraform configurado com sucesso!'
                    }
                }
            }
        }
        
        stage('‚úÖ Terraform Validate') {
            steps {
                echo 'üîç Validando configura√ß√£o Terraform...'
                dir('terraform') {
                    sh 'terraform validate -no-color'
                    echo '‚úÖ Configura√ß√£o Terraform v√°lida!'
                }
            }
        }
        
        stage('üìä Terraform Plan') {
            when {
                anyOf {
                    expression { params.ACTION == 'plan' }
                    expression { params.ACTION == 'apply' }
                }
            }
            steps {
                script {
                    echo 'üìã Executando Terraform Plan...'
                    dir('terraform') {
                        withCredentials([aws(credentialsId: 'aws-credentials', region: 'us-east-1')]) {
                            sh '''
                                terraform plan -no-color \
                                    -var="aws_region=${AWS_DEFAULT_REGION}" \
                                    -var="bucket_name=${TF_VAR_bucket_name}" \
                                    -var="environment=${TF_VAR_environment}" \
                                    -var="project_name=${TF_VAR_project_name}" \
                                    -out=tfplan
                            '''
                        }
                        echo '‚úÖ Plan executado com sucesso!'
                    }
                }
            }
        }
        
        stage('üöÄ Terraform Apply') {
            when {
                expression { params.ACTION == 'apply' }
            }
            steps {
                script {
                    echo '‚ö° Aplicando mudan√ßas Terraform...'
                    
                    // Aprova√ß√£o manual para produ√ß√£o
                    if (env.BRANCH_NAME == 'main' && !params.AUTO_APPROVE) {
                        def userInput = input(
                            message: 'üî• Aplicar mudan√ßas em PRODU√á√ÉO?',
                            ok: 'Aplicar',
                            parameters: [
                                choice(
                                    name: 'CONFIRM',
                                    choices: ['No', 'Yes'],
                                    description: 'Confirmar aplica√ß√£o em produ√ß√£o'
                                )
                            ]
                        )
                        
                        if (userInput != 'Yes') {
                            error '‚ùå Deploy cancelado pelo usu√°rio'
                        }
                    }
                    
                    dir('terraform') {
                        withCredentials([aws(credentialsId: 'aws-credentials', region: 'us-east-1')]) {
                            sh 'terraform apply -no-color -auto-approve tfplan'
                        }
                        echo '‚úÖ Apply executado com sucesso!'
                    }
                }
            }
        }
        
        stage('üåê Get Website URL') {
            when {
                expression { params.ACTION == 'apply' }
            }
            steps {
                script {
                    echo 'üîó Obtendo URL do website...'
                    dir('terraform') {
                        withCredentials([aws(credentialsId: 'aws-credentials', region: 'us-east-1')]) {
                            def websiteUrl = sh(
                                script: 'terraform output -raw website_url',
                                returnStdout: true
                            ).trim()
                            
                            echo "üéâ Website URL: ${websiteUrl}"
                            
                            // Salvar URL como artefato
                            writeFile file: '../website_url.txt', text: websiteUrl
                            archiveArtifacts artifacts: 'website_url.txt', fingerprint: true
                            
                            // Exibir na sa√≠da
                            echo """
                            ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
                            ‚ïë          üöÄ DEPLOY CONCLU√çDO!        ‚ïë
                            ‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
                            ‚ïë URL: ${websiteUrl}
                            ‚ïë Ambiente: ${env.TF_VAR_environment}
                            ‚ïë Bucket: ${env.TF_VAR_bucket_name}
                            ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
                            """.stripIndent()
                        }
                    }
                }
            }
        }
        
        stage('üß™ Test Website') {
            when {
                expression { params.ACTION == 'apply' }
            }
            steps {
                script {
                    echo 'üîç Testando website...'
                    dir('terraform') {
                        withCredentials([aws(credentialsId: 'aws-credentials', region: 'us-east-1')]) {
                            def websiteUrl = sh(
                                script: 'terraform output -raw website_url',
                                returnStdout: true
                            ).trim()
                            
                            // Aguardar propaga√ß√£o do S3
                            echo '‚è±Ô∏è Aguardando propaga√ß√£o do S3 (30s)...'
                            sleep 30
                            
                            // Testar se o site est√° acess√≠vel
                            def response = sh(
                                script: "curl -s -o /dev/null -w '%{http_code}' --connect-timeout 30 ${websiteUrl}",
                                returnStdout: true
                            ).trim()
                            
                            if (response == '200') {
                                echo '‚úÖ Website est√° funcionando corretamente!'
                                echo "üåê Acesse: ${websiteUrl}"
                            } else {
                                echo "‚ö†Ô∏è Website retornou c√≥digo HTTP: ${response}"
                                echo "üîÑ Isso pode ser normal logo ap√≥s o deploy. Tente acessar em alguns minutos."
                            }
                        }
                    }
                }
            }
        }
        
        stage('üí• Terraform Destroy') {
            when {
                expression { params.ACTION == 'destroy' }
            }
            steps {
                script {
                    echo 'üóëÔ∏è Destruindo recursos Terraform...'
                    
                    // Confirma√ß√£o obrigat√≥ria para destroy
                    def userInput = input(
                        message: '‚ö†Ô∏è DESTRUIR todos os recursos?',
                        ok: 'Destruir',
                        parameters: [
                            choice(
                                name: 'CONFIRM_DESTROY',
                                choices: ['No', 'Yes'],
                                description: 'Confirmar destrui√ß√£o (IRREVERS√çVEL)'
                            )
                        ]
                    )
                    
                    if (userInput != 'Yes') {
                        error '‚ùå Destrui√ß√£o cancelada pelo usu√°rio'
                    }
                    
                    dir('terraform') {
                        withCredentials([aws(credentialsId: 'aws-credentials', region: 'us-east-1')]) {
                            sh '''
                                terraform destroy -no-color -auto-approve \
                                    -var="aws_region=${AWS_DEFAULT_REGION}" \
                                    -var="bucket_name=${TF_VAR_bucket_name}" \
                                    -var="environment=${TF_VAR_environment}" \
                                    -var="project_name=${TF_VAR_project_name}"
                            '''
                        }
                        echo '‚úÖ Recursos destru√≠dos com sucesso!'
                    }
                }
            }
        }
    }
    
    post {
        always {
            echo 'üßπ Limpando workspace...'
            // Limpar arquivos terraform sens√≠veis
            sh 'find . -name "*.tfstate*" -delete 2>/dev/null || true'
            sh 'find . -name "tfplan" -delete 2>/dev/null || true'
        }
        
        success {
            script {
                def message = ""
                if (params.ACTION == 'apply') {
                    def websiteUrl = readFile('website_url.txt').trim()
                    message = """
                    üéâ Deploy realizado com sucesso!
                    üåê URL: ${websiteUrl}
                    üè∑Ô∏è Ambiente: ${env.TF_VAR_environment}
                    üì¶ Bucket: ${env.TF_VAR_bucket_name}
                    """
                } else {
                    message = "‚úÖ ${params.ACTION} executado com sucesso!"
                }
                
                echo message
                
                // Se tiver configurado email, descomentar:
                // emailext (
                //     subject: "‚úÖ Jenkins: ${env.JOB_NAME} - ${params.ACTION} Success",
                //     body: message,
                //     to: '${DEFAULT_RECIPIENTS}'
                // )
            }
        }
        
        failure {
            echo '‚ùå Pipeline falhou!'
            
            // Se tiver configurado email, descomentar:
            // emailext (
            //     subject: "‚ùå Jenkins: ${env.JOB_NAME} - ${params.ACTION} Failed",
            //     body: "Build falhou. Verifique os logs: ${env.BUILD_URL}console",
            //     to: '${DEFAULT_RECIPIENTS}'
            // )
        }
    }
}